/*
	Copyright Kamil PÄ™kala http://github.com/kamilkp
	angular-sortable-view v0.0.13 2015/01/13
*/
!function(a,b){"use strict";function c(a){if(!("clientX"in a||"clientY"in a)){var b=a.touches||a.originalEvent.touches;b&&b.length&&(a.clientX=b[0].clientX,a.clientY=b[0].clientY),a.preventDefault()}}function d(a){if(a=a[0],a.previousElementSibling)return b.element(a.previousElementSibling);for(var c=a.previousSibling;null!=c&&1!=c.nodeType;)c=c.previousSibling;return b.element(c)}function e(a,b){var c=d(a);c.length>0?c.after(b):a.parent().prepend(b)}function f(a,c){if(a instanceof b.element&&(a=a[0]),null!==j)return a[j](c)}function g(a){for(a=a.parentNode;a!==document.documentElement;){var c=b.element(a).css("position");if("static"!=c&&""!=c)return a.getBoundingClientRect();a=a.parentNode}return null}var h=b.module("angular-sortable-view",[]);h.directive("svRoot",[function(){function a(a,b,c){return c?a.x-b.x<0:a.y-b.y<0}function b(a){return i[a]}function c(a){delete i[a]}function d(a){return[{x:a.left,y:a.top},{x:a.left+a.width,y:a.top},{x:a.left,y:a.top+a.height},{x:a.left+a.width,y:a.top+a.height},{x:a.left+a.width/2,y:a.top+a.height/2}]}function g(a,b){return a.x>=b[0].x&&a.x<=b[1].x&&a.y>=b[0].y&&a.y<=b[2].y?0:Math.min.apply(Math,b.map(function(b){return(b.x-a.x)*(b.x-a.x)+(b.y-a.y)*(b.y-a.y)}))}var h,i=Object.create(null);return{restrict:"A",controller:["$scope","$attrs","$interpolate","$parse",function(j,k,l,m){var n=l(k.svRoot)(j)||j.$id;i[n]||(i[n]=[]),k.$observe("svRoot",function(a){if(n!==a){var c=n;n=a,i[n]||(i[n]=[]),i[n]=b(c).filter(function(a){return a.getPart().element.attr("sv-root")===n}),i[c]=b(c).filter(function(a){return a.getPart().element.attr("sv-root")!==n})}});var o,p,q,r,s,t=this,u=!1,v=m(k.svOnSort);k.svOnStart=k.$$element[0].attributes["sv-on-start"],k.svOnStart=k.svOnStart&&k.svOnStart.value,k.svOnStop=k.$$element[0].attributes["sv-on-stop"],k.svOnStop=k.svOnStop&&k.svOnStop.value;var w=m(k.svOnStart),x=m(k.svOnStop);if(this.sortingInProgress=function(){return h},k.svGrid){if(null===(u="true"===k.svGrid||"false"!==k.svGrid&&null))throw"Invalid value of sv-grid attribute"}else j.$watchCollection(function(){return b(n)},function(a){u=!1;var b=a.filter(function(a){return!a.container}).map(function(a){return{part:a.getPart().id,y:a.element[0].getBoundingClientRect().top}}),c=Object.create(null);b.forEach(function(a){c[a.part]?c[a.part].push(a.y):c[a.part]=[a.y]}),Object.keys(c).forEach(function(a){c[a].sort(),c[a].forEach(function(b,d){d<c[a].length-1&&b>0&&b===c[a][d+1]&&(u=!0)})})});this.$moveUpdate=function(c,i,k,l,m,v,x){var y=k[0].getBoundingClientRect();"element"===c.tolerance&&(i={x:~~(y.left+y.width/2),y:~~(y.top+y.height/2),offset:{x:0,y:0}}),h=!0,o=[],p||(m?(p=m.clone(),p.removeClass("ng-hide")):(p=l.clone(),p.addClass("sv-visibility-hidden"),p.addClass("sv-placeholder"),p.css({height:y.height+"px",width:y.width+"px"})),l.after(p),v.copyMode||l.addClass("ng-hide"),s=l,q=c,r=k,w(j,{$helper:{element:r},$part:v.model(v.scope),$index:x,$item:v.model(v.scope)[x]}),j.$root&&j.$root.$$phase||j.$apply()),r[0].reposition({x:i.x+document.body.scrollLeft-i.offset.x*y.width,y:i.y+document.body.scrollTop-i.offset.y*y.height}),b(n).forEach(function(b){if(null==c.containment||f(b.element,c.containment)||f(b.element,c.containment+" *")){var e=b.element[0].getBoundingClientRect(),h=d(e),j={x:~~(e.left+e.width/2),y:~~(e.top+e.height/2)},k={x:~~(e.left+e.width/2),y:~~e.top},l={x:~~e.left,y:~~(e.top+e.height/2)};if(!b.container&&(b.element[0].scrollHeight||b.element[0].scrollWidth)){var m=b.getPart();o.push({element:b.element,q:g(i,h),view:m,targetIndex:b.getIndex(),after:a(j,i,"isGrid"in m?m.isGrid:u)})}if(b.container&&!b.element[0].querySelector("[sv-element]:not(.sv-placeholder):not(.sv-source)")){var n=j;"vertical"===b.centerVariant?n=l:"horizontal"===b.centerVariant&&(n=k),o.push({element:b.element,q:(n.x-i.x)*(n.x-i.x)+(n.y-i.y)*(n.y-i.y),view:b.getPart(),targetIndex:0,container:!0})}}});var z=p[0].getBoundingClientRect();o.push({q:g(i,d(z)),element:p,placeholder:!0}),o.sort(function(a,b){return a.q-b.q}),o.forEach(function(a,b){0!==b||a.placeholder||a.container?0===b&&a.container?(t.$target=a,a.element.append(p)):a.element.removeClass("sv-candidate"):(t.$target=a,a.element.addClass("sv-candidate"),a.after?a.element.after(p):e(a.element,p))})},this.$drop=function(a,b,c){function d(){if(h=!1,p.remove(),r.remove(),s.removeClass("ng-hide"),o=void 0,p=void 0,c=void 0,r=void 0,s=void 0,x(j,{$part:a.model(a.scope),$index:b,$item:a.model(a.scope)[b],$partToScope:t.$target.view.scope,$partFromScope:a.scope}),t.$target){t.$target.element.removeClass("sv-candidate");var d=a.model(a.scope).splice(b,1),e=t.$target.targetIndex;t.$target.view.model(t.$target.view.scope).splice(e,0,d[0]),t.$target.view===a&&b===e||v(j,{$partTo:t.$target.view.model(t.$target.view.scope),$partFrom:a.model(a.scope),$item:d[0],$indexTo:e,$indexFrom:b,$partToScope:t.$target.view.scope,$partFromScope:a.scope})}t.$target=void 0,j.$root&&j.$root.$$phase||j.$apply()}if(p)if(!c.revert||t.$target&&t.$target.view&&t.$target.view.noRevert)d();else{var e=p[0].getBoundingClientRect(),f=r[0].getBoundingClientRect(),g=Math.sqrt(Math.pow(f.top-e.top,2)+Math.pow(f.left-e.left,2)),i=+c.revert*g/200;i=Math.min(i,+c.revert),["-webkit-","-moz-","-ms-","-o-",""].forEach(function(a){void 0!==r[0].style[a+"transition"]&&(r[0].style[a+"transition"]="all "+i+"ms ease")}),setTimeout(d,i),r.css({top:e.top+document.body.scrollTop+"px",left:e.left+document.body.scrollLeft+"px"})}},this.addToSortableElements=function(a){b(n).push(a)},this.removeFromSortableElements=function(a){var d=b(n),e=d.indexOf(a);e>-1&&(d.splice(e,1),0===d.length&&c(n))}}]}}]),h.directive("svPart",["$parse",function(a){return{restrict:"A",require:"^svRoot",controller:["$scope",function(a){a.$ctrl=this,this.getPart=function(){return a.part},this.$drop=function(b,c){a.$sortableRoot.$drop(a.part,b,c)}}],scope:!0,link:function(b,c,d,e){if(!d.svPart)throw new Error("no model provided");var f=a(d.svPart);if(!f.assign)throw new Error("model not assignable");b.part={id:b.$id,element:c,model:f,copyMode:"true"===d.svCopy,noRevert:"true"===d.svNoRevert,scope:b},"isGrid"in d&&(b.part.isGrid="true"===d.isGrid),b.$sortableRoot=e;var g={element:c,getPart:b.$ctrl.getPart,container:!0,centerVariant:d.svCenter||"both",disabled:"true"===d.svDisabled};e.addToSortableElements(g),b.$on("$destroy",function(){e.removeFromSortableElements(g)})}}}]),h.directive("svElement",["$parse",function(d){return{restrict:"A",require:["^svPart","^svRoot"],controller:["$scope",function(a){a.$ctrl=this}],link:function(e,f,h,i){function j(j){function l(a){c(a),p||(f.parent().prepend(v),p=!0),i[1].$moveUpdate(t,{x:a.clientX,y:a.clientY,offset:y},v,f,o,i[0].getPart(),e.$index)}if(c(j),!i[1].sortingInProgress()&&(0==j.button||"mousedown"!==j.type)){var r=m[0].attributes["sv-stop"];if(!r||"true"!==r.value){var s=j.target.attributes["sv-handle-disabled"];if(!s||"true"!==s.value){p=!1;var t=d(h.svElement)(e);if(t=b.extend({},{tolerance:"pointer",revert:200,containment:"html"},t),t.containment)var u=k.call(f,t.containment)[0].getBoundingClientRect();var v,w=f,x=f[0].getBoundingClientRect();n||(n=i[0].helper),o||(o=i[0].placeholder),n?(v=n.clone(),v.removeClass("ng-hide"),v.css({left:x.left+document.body.scrollLeft+"px",top:x.top+document.body.scrollTop+"px"}),w.addClass("sv-visibility-hidden")):(v=w.clone(),v.addClass("sv-helper").css({left:x.left+document.body.scrollLeft+"px",top:x.top+document.body.scrollTop+"px",width:x.width+"px"})),v[0].reposition=function(b){var c=document.body,d=b.x,e=b.y,h=v[0].getBoundingClientRect(),i=g(f[0]),j=function b(c){var d=a.getComputedStyle(c.parentNode).overflowY;return c.parentNode===document.body||"scroll"===d||"auto"===d?c.parentNode:b(c.parentNode)}(f[0]);u&&(e<u.top+c.scrollTop&&(e=u.top+c.scrollTop),j.scrollBy(0,~~((b.y-e)/2)),e+h.height>u.top+c.scrollTop+u.height&&(e=u.top+c.scrollTop+u.height-h.height),j.scrollBy(0,~~((b.y-e)/2)),d<u.left+c.scrollLeft&&(d=u.left+c.scrollLeft),d+h.width>u.left+c.scrollLeft+u.width&&(d=u.left+c.scrollLeft+u.width-h.width)),i&&(e-=i.top,d-=i.left),this.style.left=d-c.scrollLeft+"px",this.style.top=e-c.scrollTop+"px"};var y={x:(j.clientX-x.left)/x.width,y:(j.clientY-x.top)/x.height};q.addClass("sv-sorting-in-progress"),q.on("mousemove touchmove",l).on("mouseup touchend touchcancel",function a(){q.off("mousemove touchmove",l),q.off("mouseup touchend touchcancel",a),q.removeClass("sv-sorting-in-progress"),p&&i[0].$drop(e.$index,t),f.removeClass("sv-visibility-hidden")})}}}}var l={element:f,getPart:i[0].getPart,getIndex:function(){return e.$index},disabled:"true"===h.svDisabled};i[1].addToSortableElements(l),e.$on("$destroy",function(){i[1].removeFromSortableElements(l)});var m=f;m.on("mousedown touchstart",j),e.$watch("$ctrl.handle",function(a){a&&(m.off("mousedown touchstart",j),m=a,m.on("mousedown touchstart",j))});var n;e.$watch("$ctrl.helper",function(a){a&&(n=a)});var o;e.$watch("$ctrl.placeholder",function(a){a&&(o=a)});var p,q=b.element(document.documentElement)}}}]),h.directive("svHandle",function(){return{require:"?^svElement",link:function(a,b,c,d){d&&(d.handle=b.add(d.handle))}}}),h.directive("svHelper",function(){return{require:["?^svPart","?^svElement"],link:function(a,b,c,d){b.addClass("sv-helper").addClass("ng-hide"),d[1]?d[1].helper=b:d[0]&&(d[0].helper=b)}}}),h.directive("svPlaceholder",function(){return{require:["?^svPart","?^svElement"],link:function(a,b,c,d){b.addClass("sv-placeholder").addClass("ng-hide"),d[1]?d[1].placeholder=b:d[0]&&(d[0].placeholder=b)}}}),b.element(document.head).append(["<style>.sv-helper{position: fixed !important;z-index: 99999;margin: 0 !important;}.sv-candidate{}.sv-placeholder{}.sv-sorting-in-progress{-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;}.sv-visibility-hidden{visibility: hidden !important;opacity: 0 !important;}</style>"].join(""));var i=document.documentElement,j=i.matches?"matches":i.matchesSelector?"matchesSelector":i.webkitMatches?"webkitMatches":i.webkitMatchesSelector?"webkitMatchesSelector":i.msMatches?"msMatches":i.msMatchesSelector?"msMatchesSelector":i.mozMatches?"mozMatches":i.mozMatchesSelector?"mozMatchesSelector":null;if(null==j)throw"This browser doesn't support the HTMLElement.matches method";var k=b.element.prototype.closest||function(a){for(var c=this[0].parentNode;c!==document.documentElement&&!c[j](a);)c=c.parentNode;return c[j](a)?b.element(c):b.element()};"function"!=typeof b.element.prototype.add&&(b.element.prototype.add=function(a){var c,d=b.element();for(a=b.element(a),c=0;c<this.length;c++)d.push(this[c]);for(c=0;c<a.length;c++)d.push(a[c]);return d})}(window,angular);